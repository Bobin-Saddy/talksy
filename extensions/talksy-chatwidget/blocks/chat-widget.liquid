{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: #ffffff; color: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header">
    <div class="header-content">
      <div id="header-avatar-container" class="avatar-stack">
        <div class="avatar-status"></div>
        <img id="main-support-avatar" src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      </div>
      <div class="header-text">
        <span id="header-title-text" class="header-title">Live Support</span>
        <span id="header-subtitle-text" class="header-subtitle"><span class="pulse"></span></span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="tab-home" class="tab-content">
    <div class="home-hero" id="home-hero-bg"> 
      <h1 id="welcome-h1">Hi there ðŸ‘‹</h1>
      <p id="welcome-p">We are here to help you! Ask us anything.</p>
    </div>
    <div class="home-card" id="start-chat-trigger">
      <div class="card-text">
        <strong id="card-msg-text">Send us a message</strong>
        <span id="card-reply-time">Typically replies in 5 minutes</span>
      </div>
      <div class="card-arrow" id="card-arrow-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
    </div>
  </div>

  <div id="tab-chat" class="tab-content" style="display:none;">
    <div id="chat-onboarding-step" class="step-container">
      <div class="welcome-card">
        <h3 id="onboarding-title">Start a conversation</h3>
        <p id="onboarding-p">Please provide your details to begin.</p>
        <div class="input-group">
          <div class="input-field-wrapper">
            <input id="chat-fname" type="text" placeholder="First Name" />
            <span class="error-message" id="fname-error"></span>
          </div>
          <div class="input-field-wrapper">
            <input id="chat-email" type="email" placeholder="Email Address" />
            <span class="error-message" id="email-error"></span>
          </div>
          <button id="chat-submit-info">Continue to Chat</button>
        </div>
      </div>
    </div>

    <div id="chat-chat-step" class="step-container" style="display:none;">
      <div id="chat-messages"></div>
      <div id="image-preview-container" style="display:none;">
        <div id="image-preview-wrapper">
          <img id="image-preview" src="" alt="Preview" />
          <button id="remove-image-btn">Ã—</button>
        </div>
        <button id="send-image-btn">Send Image</button>
      </div>
      <div id="chat-footer">
        <div id="emoji-picker" class="hidden-picker"></div>
        <div class="input-wrapper">
          <button id="emoji-btn" class="tool-btn">ðŸ˜Š</button>
          <button id="file-btn" class="tool-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
          </button>
          <input id="chat-file-input" type="file" style="display:none;" accept="image/*, .pdf, .svg" />
          <input id="chat-input" placeholder="Write a message..." autocomplete="off" />
          <button id="chat-send">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Messages</span>
    </div>
  </div>
</div>

<style>
:root { 
  --chat-primary: {{ primary_color }}; 
  --chat-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --chat-base-size: 15px; 
}

#chat-widget * { box-sizing: border-box; font-family: var(--chat-font-family) !important; }

/* LAUNCHER UPDATED: Background forced to white, icon to primary */
#chat-launcher { 
  position: fixed; 
  bottom: 25px; 
  right: 25px; 
  width: 60px; 
  height: 60px; 
  border-radius: 50%; 
  background: #ffffff !important; 
  color: var(--chat-primary) !important; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  z-index: 999999; 
  box-shadow: 0 10px 30px rgba(0,0,0,0.18); 
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
}
#chat-launcher:hover { transform: scale(1.1); }

/* Rest of CSS remains identical to yours */
#chat-widget { position: fixed; bottom: 100px; right: 25px; width: 370px; height: 600px; max-height: calc(100vh - 130px); background: #ffffff; border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.15); z-index: 999998; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); border: 1px solid rgba(0,0,0,0.05); font-size: var(--chat-base-size); }
.chat-hidden { opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
#chat-header { padding: 20px; color: #fff; display: flex; justify-content: space-between; align-items: center; background: var(--chat-primary); flex-shrink: 0; }
.header-content { display: flex; align-items: center; gap: 12px; }
.avatar-stack { position: relative; width: 40px; height: 40px; }
.avatar-stack img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }
.avatar-status { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background: #22c55e; border: 2px solid #fff; border-radius: 50%; }
.header-title { display: block; font-weight: 700; font-size: 1.1em; }
.header-subtitle { font-size: 0.8em; opacity: 0.9; display: flex; align-items: center; gap: 6px; }
.pulse { display: inline-block; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse-animation 2s infinite; }
@keyframes pulse-animation { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
#chat-close { background: none; border: none; color: inherit; cursor: pointer; padding: 5px; opacity: 0.8; }
.tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.step-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.home-hero { padding: 30px 20px 60px; background: var(--chat-primary); color: #fff; text-align: left; }
.home-hero h1 { font-size: 1.8em; margin: 0 0 8px; font-weight: 700; }
.home-hero p { font-size: 0.95em; opacity: 0.9; margin: 0; line-height: 1.4; }
.home-card { background: white; margin: -30px 15px 15px; padding: 18px; border-radius: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 25px rgba(0,0,0,0.06); cursor: pointer; border: 1px solid #f0f0f0; transition: transform 0.2s; }
.home-card:hover { transform: translateY(-2px); }
.card-text strong { display: block; font-size: 0.95em; margin-bottom: 2px; }
.card-text span { font-size: 0.8em; color: #64748b; }
.card-arrow { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.welcome-card { padding: 30px 20px; text-align: center; }
.welcome-card h3 { margin-bottom: 8px; font-size: 1.2em; font-weight: 700; }
.welcome-card p { margin-bottom: 20px; font-size: 0.9em; opacity: 0.7; }
.input-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
.input-field-wrapper { position: relative; }
.input-group input { padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; width: 100%; transition: all 0.3s ease; font-size: 0.95em; background: #fff; }
.input-group input:focus { border-color: var(--chat-primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
.input-group input.error { border-color: #ef4444; background: #fef2f2; }
.error-message { display: block; color: #ef4444; font-size: 11px; margin-top: 4px; text-align: left; min-height: 14px; font-weight: 500; }
.input-group button { padding: 13px; border: none; border-radius: 12px; color: #fff; font-weight: 700; cursor: pointer; transition: all 0.3s; font-size: 0.95em; margin-top: 5px; }
.input-group button:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
#chat-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }
.msg { max-width: 85%; display: flex; flex-direction: column; }
.msg.user { align-self: flex-end; }
.msg.bot { align-self: flex-start; }
.msg-content { padding: 10px 14px; border-radius: 14px; font-size: 0.95em; line-height: 1.4; word-wrap: break-word; }
.user .msg-content { background: var(--chat-primary); color: #fff; border-bottom-right-radius: 2px; }
.bot .msg-content { background: #fff; color: #1e293b; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
#image-preview-container { padding: 15px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: none; }
#image-preview-wrapper { position: relative; margin-bottom: 10px; }
#image-preview { max-width: 100%; max-height: 200px; border-radius: 12px; display: block; }
#remove-image-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 20px; line-height: 1; display: flex; align-items: center; justify-content: center; }
#send-image-btn { width: 100%; padding: 10px; background: var(--chat-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
#chat-footer { padding: 12px; background: #fff; border-top: 1px solid #f1f5f9; }
.input-wrapper {
    display: flex;
    align-items: center;
    background: #f1f5f9;
    border-radius: 12px;
    padding: 6px 10px;
    gap: 5px;
    border: 1px solid rgb(84, 51, 235);
}
#chat-input {
    flex: 1;
    border: none;
    background: transparent;
    outline: none;
    padding: 8px;
    font-size: 0.95em;
    border-radius: 8px;
    box-shadow: none;
}
.tool-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 4px; display: flex; align-items: center; color: #64748b; }
#chat-send { background: var(--chat-primary); color: #fff; border: none; border-radius: 8px; padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#chat-nav { display: flex; border-top: 1px solid #f1f5f9; background: #fff; padding: 5px 0; flex-shrink: 0; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 8px; cursor: pointer; font-size: 10px; color: #94a3b8; gap: 4px; }
.nav-item.active { color: var(--chat-primary); font-weight: 600; }
.hidden-picker { display: none !important; }
#emoji-picker { position: absolute; bottom: 70px; left: 10px; right: 10px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; z-index: 10; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
.header-text {
    display: flex;
    gap: 6px;
}
</style>

<script>
// (All your Javascript remains exactly the same as provided in your prompt)
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://talksy-production-322d.up.railway.app"; 
  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const chatInput = document.getElementById("chat-input");
  const msgBox = document.getElementById("chat-messages");
  let selectedImage = null;
  let pollingInterval = null; 
  
  // Is Set mein hum render ho chuke IDs ko track karte hain
  let renderedMessageIds = new Set();

  function validateName(name) {
    const trimmed = name.trim();
    if (trimmed.length < 2) return { valid: false, error: "Name must be at least 2 characters" };
    if (trimmed.length > 50) return { valid: false, error: "Name is too long" };
    if (!/^[a-zA-Z\s'-]+$/.test(trimmed)) return { valid: false, error: "Name can only contain letters" };
    return { valid: true, error: "" };
  }

  function validateEmail(email) {
    const trimmed = email.trim();
    if (!trimmed) return { valid: false, error: "Email is required" };
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(trimmed)) return { valid: false, error: "Please enter a valid email address" };
    return { valid: true, error: "" };
  }

  function showError(inputId, errorId, errorMessage) {
    const input = document.getElementById(inputId);
    const errorSpan = document.getElementById(errorId);
    if(input) input.classList.add('error');
    if(errorSpan) errorSpan.textContent = errorMessage;
  }

  function clearError(inputId, errorId) {
    const input = document.getElementById(inputId);
    const errorSpan = document.getElementById(errorId);
    if(input) input.classList.remove('error');
    if(errorSpan) errorSpan.textContent = '';
  }

  async function fetchAndApplySettings() {
    const ICON_MAP = {
      bubble: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
      support: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
      sparkle: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>`,
      send: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>`,
      custom: `<img src="https://alert-lime-e4qtqvlkob.edgeone.app/icon-frame.png" style="width:76px; height:74px; margin-top:11px;" />`
    };

    try {
      const response = await fetch(`${BASE_URL}/api/chat-settings?shop=${shop}`);
      if (!response.ok) return;
      const s = await response.json();
      
      if (s) {
        if (s.fontFamily) document.documentElement.style.setProperty('--chat-font-family', s.fontFamily);
        if (s.baseFontSize) document.documentElement.style.setProperty('--chat-base-size', s.baseFontSize);
        document.documentElement.style.setProperty('--chat-primary', s.primaryColor);

        if(launcher) {
            launcher.style.background = "#ffffff";
            launcher.style.color = s.primaryColor;
        }

        const header = document.getElementById("chat-header");
        const hero = document.getElementById("home-hero-bg");
        if(header) header.style.background = s.headerBgColor;
        if(hero) hero.style.background = s.heroBgColor;

        ["chat-send", "chat-submit-info", "send-image-btn"].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.style.background = s.primaryColor;
        });

        const titleText = document.getElementById("header-title-text");
        if(titleText) { titleText.innerText = s.headerTitle || "Live Support"; titleText.style.color = s.headerTextColor; }
        const welcomeH1 = document.getElementById("welcome-h1");
        if(welcomeH1) { welcomeH1.innerText = s.welcomeText || "Hi there ðŸ‘‹"; welcomeH1.style.color = s.heroTextColor; }
        const welcomeP = document.getElementById("welcome-p");
        if(welcomeP) { welcomeP.innerText = s.welcomeSubtext || "We are here to help you!"; welcomeP.style.color = s.heroTextColor; }
        const cardTitle = document.getElementById("card-msg-text");
        const cardSub = document.getElementById("card-reply-time");
        if(cardTitle) { cardTitle.innerText = s.startConversationText || "Send us a message"; cardTitle.style.color = s.cardTitleColor; }
        if(cardSub) { cardSub.innerText = s.replyTimeText || "Typically replies in 5 minutes"; cardSub.style.color = s.cardSubtitleColor; }
        const onboardingTitle = document.getElementById("onboarding-title");
        const onboardingSub = document.getElementById("onboarding-p");
        if(onboardingTitle) { onboardingTitle.innerText = s.onboardingTitle || "Start a conversation"; onboardingTitle.style.color = s.onboardingTextColor; }
        if(onboardingSub) { onboardingSub.innerText = s.onboardingSubtitle || "Please provide your details to begin."; onboardingSub.style.color = s.onboardingTextColor; }

        const launcherIconContainer = document.getElementById("launcher-icon");
        if(launcherIconContainer) { launcherIconContainer.innerHTML = ICON_MAP[s.launcherIcon] || ICON_MAP['custom']; }
        if(s.welcomeImg) { const avatar = document.getElementById("main-support-avatar"); if(avatar) avatar.src = s.welcomeImg; }
      }
    } catch (e) { console.error("Settings sync failed", e); }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const targetTab = document.getElementById(`tab-${tabId}`);
    const targetNav = document.querySelector(`[data-tab="${tabId}"]`);
    if(targetTab) targetTab.style.display = 'flex';
    if(targetNav) targetNav.classList.add('active');
  }

  if(launcher) {
    launcher.addEventListener('click', () => {
      const isVisible = widget.classList.contains("chat-visible");
      widget.classList.toggle("chat-visible", !isVisible);
      widget.classList.toggle("chat-hidden", isVisible);
      const lIcon = document.getElementById("launcher-icon");
      const cIcon = document.getElementById("close-launcher-icon");
      if(lIcon) lIcon.style.display = isVisible ? "block" : "none";
      if(cIcon) cIcon.style.display = isVisible ? "none" : "block";
    });
  }

  const closeBtn = document.getElementById("chat-close");
  if(closeBtn) closeBtn.onclick = () => launcher.click();
  document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('click', () => switchTab(item.dataset.tab)); });
  const startTrigger = document.getElementById('start-chat-trigger');
  if(startTrigger) { startTrigger.addEventListener('click', () => { switchTab('chat'); loadMessages(); }); }

  const addMessageToUI = (m) => {
    // Agar message ID already rendered hai, toh function exit kar do
    if (m.id && renderedMessageIds.has(m.id)) return;
    
    // ID generate karo agar available nahi hai (Temporary optimistic UI ke liye)
    const displayId = m.id || `temp-${Date.now()}-${Math.random()}`;
    if (m.id) renderedMessageIds.add(m.id);

    const div = document.createElement("div");
    div.id = `msg-${displayId}`;
    div.className = `msg ${m.sender}`;
    const isImg = m.fileUrl && (m.fileUrl.match(/\.(jpeg|jpg|gif|png|svg)$/i) || m.fileUrl.startsWith('data:image'));
    let contentHtml = `<div class="msg-content">${m.message || ""}`;
    if(m.fileUrl) {
      contentHtml += isImg 
        ? `<img src="${m.fileUrl}" class="msg-image" style="max-width:100%; border-radius:8px; margin-top:5px; cursor:pointer;" onclick="window.open('${m.fileUrl}')" />`
        : `<br><a href="${m.fileUrl}" target="_blank" style="font-size:12px; font-weight:bold; color:inherit; text-decoration:underline;">ðŸ“Ž Attachment</a>`;
    }
    contentHtml += `</div>`;
    const time = m.createdAt ? new Date(m.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    div.innerHTML = `${contentHtml}<div class="msg-meta" style="font-size:9px; opacity:0.5; margin-top:2px; align-self:${m.sender === 'user' ? 'flex-end' : 'flex-start'}">${time}</div>`;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  async function loadMessages() {
    const sessionId = localStorage.getItem("chat_session");
    if (!sessionId) return;
    try {
      const res = await fetch(`${BASE_URL}/app/chat/messages?shop=${shop}&sessionId=${sessionId}`);
      if (res.ok) {
        const data = await res.json();
        if (data.length === 0) return;
        
        data.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        
        data.forEach(m => {
          // Yahan check hota hai: Agar ID set mein nahi hai toh hi UI mein add karo
          if (!renderedMessageIds.has(m.id)) {
            addMessageToUI(m);
          }
        });
      }
    } catch (e) { console.error("Load messages failed", e); }
  }

  const fNameEl = document.getElementById("chat-fname");
  const emailEl = document.getElementById("chat-email");
  if(fNameEl) { fNameEl.addEventListener('blur', (e) => { const v = validateName(e.target.value); if (e.target.value.trim() !== '' && !v.valid) showError('chat-fname', 'fname-error', v.error); else clearError('chat-fname', 'fname-error'); }); }
  if(emailEl) { emailEl.addEventListener('blur', (e) => { const v = validateEmail(e.target.value); if (e.target.value.trim() !== '' && !v.valid) showError('chat-email', 'email-error', v.error); else clearError('chat-email', 'email-error'); }); }

  const submitBtn = document.getElementById("chat-submit-info");
  if(submitBtn) {
    submitBtn.onclick = async () => {
      const fname = fNameEl.value.trim();
      const email = emailEl.value.trim();
      const nv = validateName(fname);
      const ev = validateEmail(email);
      if (!nv.valid) return showError('chat-fname', 'fname-error', nv.error);
      if (!ev.valid) return showError('chat-email', 'email-error', ev.error);
      const sessionId = "sess_" + Math.random().toString(36).substr(2, 9);
      try {
        const res = await fetch(`${BASE_URL}/app/chat/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ shop, fname, email, sessionId })
        });
        if (res.ok) {
          localStorage.setItem("chat_session", sessionId);
          localStorage.setItem("chat_user_email", email);
          document.getElementById("chat-onboarding-step").style.display = "none";
          document.getElementById("chat-chat-step").style.display = "flex";
          loadMessages();
          startPolling();
        }
      } catch (e) {}
    };
  }

  async function handleSend(customText = "", fileUrl = null) {
    const text = customText || chatInput.value.trim();
    const sId = localStorage.getItem("chat_session");
    const email = localStorage.getItem("chat_user_email");
    if ((!text && !fileUrl) || !sId) return;
    
    // FIX: Optimistic message ko ek unique temp ID dena zaroori hai
    const tempId = `optimistic-${Date.now()}`;
    const tempMsg = { 
      id: tempId, 
      sender: 'user', 
      message: text, 
      fileUrl, 
      createdAt: new Date() 
    };
    
    // Optimistically UI mein add karo aur ID set mein save karo
    renderedMessageIds.add(tempId);
    addMessageToUI(tempMsg);
    
    chatInput.value = "";
    try {
      const response = await fetch(`${BASE_URL}/app/chat/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId: sId, message: text, shop, email, fileUrl })
      });

      if(response.ok) {
          // Success hone ke baad, database wali real ID fetch karne ke liye loadMessages call karo
          loadMessages();
      }
    } catch (e) { 
        console.error("Send failed", e); 
    }
  }

  function startPolling() { 
    if (pollingInterval) clearInterval(pollingInterval); 
    pollingInterval = setInterval(loadMessages, 4000); 
  }

  const sendAction = document.getElementById("chat-send");
  if(sendAction) sendAction.onclick = () => handleSend();
  if(chatInput) chatInput.onkeydown = (e) => { if (e.key === "Enter") handleSend(); };
  
  const fileTrigger = document.getElementById("file-btn");
  if(fileTrigger) fileTrigger.onclick = () => document.getElementById("chat-file-input").click();
  const fileInputEl = document.getElementById("chat-file-input");
  if(fileInputEl) {
    fileInputEl.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        selectedImage = ev.target.result;
        const prevImg = document.getElementById("image-preview");
        const prevCont = document.getElementById("image-preview-container");
        const footer = document.getElementById("chat-footer");
        if(prevImg) prevImg.src = selectedImage;
        if(prevCont) prevCont.style.display = "block";
        if(footer) footer.style.display = "none";
      };
      reader.readAsDataURL(file);
      e.target.value = '';
    };
  }

  const sendImageBtn = document.getElementById("send-image-btn");
  if(sendImageBtn) { sendImageBtn.onclick = () => { if(selectedImage) { handleSend("", selectedImage); selectedImage = null; document.getElementById("image-preview-container").style.display = "none"; document.getElementById("chat-footer").style.display = "flex"; } }; }
  const removeImageBtn = document.getElementById("remove-image-btn");
  if(removeImageBtn) { removeImageBtn.onclick = () => { selectedImage = null; document.getElementById("image-preview-container").style.display = "none"; document.getElementById("chat-footer").style.display = "flex"; }; }

  const emojiBtn = document.getElementById("emoji-btn");
  const picker = document.getElementById("emoji-picker");
  const emojis = ["ðŸ˜Š","ðŸ‘‹","ðŸ™Œ","ðŸ”¥","âœ…","ðŸ¤”","ðŸ’¡","ðŸš€","â¤ï¸","âœ¨"];
  if(picker && emojiBtn) {
    picker.innerHTML = emojis.map(e => `<span style="cursor:pointer; font-size: 18px; padding: 2px;">${e}</span>`).join("");
    emojiBtn.onclick = () => picker.classList.toggle("hidden-picker");
    picker.onclick = (e) => { if(e.target.tagName === 'SPAN') { chatInput.value += e.target.innerText; picker.classList.add("hidden-picker"); chatInput.focus(); } };
  }

  fetchAndApplySettings();
  const session = localStorage.getItem("chat_session");
  if (session) {
    const onboarding = document.getElementById("chat-onboarding-step");
    const chatActive = document.getElementById("chat-chat-step");
    if(onboarding) onboarding.style.display = "none";
    if(chatActive) chatActive.style.display = "flex";
    loadMessages();
    startPolling();
  }
})();
</script>

{% schema %}
{
  "name": "Talksy Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}