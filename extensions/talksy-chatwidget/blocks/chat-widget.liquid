{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header">
    <div class="header-content">
      <div class="avatar-stack">
        <img src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
        <div class="avatar-status"></div>
      </div>
      <div class="header-text">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="header-title">Live Support</span>
          <span class="status-dot"></span>
        </div>
      </div>
    </div>
    <button id="chat-close">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="widget-body">
    <div id="tab-home" class="tab-pane active">
      <div class="home-hero"> 
        <div class="hero-avatars">
          <img src="https://ui-avatars.com/api/?name=J&background=ddd" class="overlap">
          <img src="https://ui-avatars.com/api/?name=S&background=eee" class="overlap">
          <img src="https://ui-avatars.com/api/?name=M&background=fff" class="overlap">
        </div>
        <h1>Hi there ðŸ‘‹</h1>
        <p>How can we help you today?</p>
      </div>
      <div class="home-card" id="start-chat-trigger">
        <div class="card-text">
          <strong>Send us a message</strong>
          <span>Typically replies in 5 minutes</span>
        </div>
        <div class="card-arrow">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </div>
      </div>
    </div>

    <div id="tab-chat" class="tab-pane">
      <div id="chat-onboarding-step" class="step-container">
        <div class="onboarding-card">
          <h3>Start a conversation</h3>
          <p>Please provide your details to begin.</p>
          <div class="input-group">
            <div class="field-wrapper">
              <input id="chat-fname" type="text" placeholder="First Name" />
              <span class="error-msg" id="error-fname">Name is required</span>
            </div>
            <div class="field-wrapper">
              <input id="chat-email" type="email" placeholder="Email Address" />
              <span class="error-msg" id="error-email">Valid email is required</span>
            </div>
            <button id="chat-submit-info" style="background: {{ primary_color }};">Continue to Chat</button>
          </div>
        </div>
      </div>

      <div id="chat-chat-step" class="step-container" style="display:none;">
        <div id="chat-messages"></div>
        
        <div id="file-preview-container" style="display:none;">
            <div class="preview-box">
                <img id="image-draft-preview" src="" />
                <button id="remove-file-draft">âœ•</button>
            </div>
        </div>

        <div id="chat-footer">
          <div id="emoji-picker" class="hidden-picker"></div>
          <div class="single-line-input">
            <button id="emoji-btn" class="tool-icon">ðŸ˜Š</button>
            <button id="file-btn" class="tool-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>
            <input id="chat-file-input" type="file" style="display:none;" accept="image/*" />
            <input id="chat-input" placeholder="Message..." autocomplete="off" />
            <button id="chat-send" style="background: {{ primary_color }};">
               <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Messages</span>
    </div>
  </div>
</div>

<style>
#chat-widget * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important; }
#chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 999999; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: transform 0.2s; }
#chat-widget { position: fixed; bottom: 100px; right: 25px; width: 370px; height: 600px; max-height: calc(100vh - 140px); background: #fff; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.15); z-index: 999998; border: 1px solid rgba(0,0,0,0.05); }
.chat-hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0); pointer-events: all; }

#chat-header { padding: 18px 20px; color: #fff; display: flex; justify-content: space-between; align-items: center; background: {{ primary_color }}; flex-shrink: 0; }
.header-title { font-weight: 700; font-size: 16px; }

#widget-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f8fafc; }
.tab-pane { display: none; height: 100%; flex-direction: column; }
.tab-pane.active { display: flex; }

.home-hero { padding: 30px 20px 60px; background: {{ primary_color }}; color: #fff; flex-shrink: 0; }
.hero-avatars { display: flex; margin-bottom: 12px; }
.hero-avatars img { width: 30px; height: 30px; border-radius: 50%; border: 2px solid {{ primary_color }}; margin-right: -8px; }
.home-card { background: #fff; margin: -30px 15px 15px; padding: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; }

#chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
.msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
.msg.user { align-self: flex-end; background: {{ primary_color }}; color: #fff; border-bottom-right-radius: 4px; }
.msg.bot { align-self: flex-start; background: #fff; color: #1e293b; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
.msg img { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; }

/* File Preview Style */
#file-preview-container { padding: 10px 15px; background: #fff; border-top: 1px solid #eee; }
.preview-box { position: relative; width: 60px; height: 60px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
.preview-box img { width: 100%; height: 100%; object-fit: cover; }
#remove-file-draft { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; border: none; font-size: 10px; cursor: pointer; padding: 2px 5px; }

/* SINGLE LINE FOOTER */
#chat-footer { padding: 10px; background: #fff; border-top: 1px solid #eee; flex-shrink: 0; }
.single-line-input { display: flex; align-items: center; gap: 8px; background: #f1f5f9; border-radius: 25px; padding: 5px 10px; }
.tool-icon { background: none; border: none; color: #64748b; cursor: pointer; padding: 4px; display: flex; align-items: center; font-size: 18px; flex-shrink: 0; }
#chat-input { flex: 1; border: none; background: transparent; outline: none; padding: 8px 5px; font-size: 14px; min-width: 0; }
#chat-send { width: 34px; height: 34px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; padding: 0; }

#chat-nav { display: flex; background: #fff; border-top: 1px solid #f1f5f9; height: 60px; flex-shrink: 0; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #94a3b8; font-size: 11px; gap: 4px; }
.nav-item.active { color: {{ primary_color }}; font-weight: 600; }

.error-msg { color: #ef4444; font-size: 11px; margin-top: 4px; display: none; }
.hidden-picker { display: none !important; }
#emoji-picker { position: absolute; bottom: 75px; left: 10px; right: 10px; background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 10px; display: grid; grid-template-columns: repeat(5, 1fr); box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 100; }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://talksy-production-322d.up.railway.app";
  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const msgBox = document.getElementById("chat-messages");
  const fileInput = document.getElementById("chat-file-input");
  const previewCont = document.getElementById("file-preview-container");
  const previewImg = document.getElementById("image-draft-preview");
  
  let lastMsgCount = 0;
  let currentFileDraft = null; // Stores file until Send is clicked

  const addMsgToUI = (m) => {
    const d = document.createElement("div");
    d.className = `msg ${m.sender}`;
    if (m.fileUrl && (m.fileUrl.startsWith('data:image') || m.fileUrl.match(/\.(jpeg|jpg|gif|png)$/i))) {
      d.innerHTML = `<img src="${m.fileUrl}" onload="this.parentElement.parentElement.scrollTop = 999999;">${m.message && m.message !== "Sent a file" ? '<div>'+m.message+'</div>' : ''}`;
    } else {
      d.innerText = m.message;
    }
    msgBox.appendChild(d);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  const loadMessages = async () => {
    const sId = localStorage.getItem("chat_session");
    if (!sId) return;
    try {
      const res = await fetch(`${BASE_URL}/app/chat/messages?shop=${shop}&sessionId=${sId}`);
      if (res.ok) {
        const data = await res.json();
        if (data.length !== lastMsgCount) {
          msgBox.innerHTML = '';
          data.forEach(m => addMsgToUI(m));
          lastMsgCount = data.length;
        }
      }
    } catch (e) {}
  };

  const handleSend = async () => {
    const input = document.getElementById("chat-input");
    const text = input.value.trim();
    const fileData = currentFileDraft;

    if (!text && !fileData) return;

    const sId = localStorage.getItem("chat_session");
    const email = localStorage.getItem("chat_user_email");

    // Instant Update
    addMsgToUI({ sender: 'user', message: text, fileUrl: fileData });
    
    // Clear Drafting Area
    input.value = "";
    currentFileDraft = null;
    previewCont.style.display = "none";
    lastMsgCount++;

    try {
      await fetch(`${BASE_URL}/app/chat/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId: sId, message: text || "Sent a file", shop, email, fileUrl: fileData })
      });
    } catch (e) {}
  };

  // Launcher toggle
  launcher.onclick = () => {
    const isVis = widget.classList.contains("chat-visible");
    widget.className = isVis ? "chat-hidden" : "chat-visible";
    document.getElementById("launcher-icon").style.display = isVis ? "block" : "none";
    document.getElementById("close-launcher-icon").style.display = isVis ? "none" : "block";
    if(!isVis) loadMessages();
  };

  document.getElementById("chat-close").onclick = () => launcher.click();

  // Tab Switching
  document.querySelectorAll('.nav-item').forEach(n => {
    n.onclick = () => {
      document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      document.getElementById(`tab-${n.dataset.tab}`).classList.add('active');
      n.classList.add('active');
    };
  });
  document.getElementById("start-chat-trigger").onclick = () => document.querySelector('[data-tab="chat"]').click();

  // Drafting File Logic
  document.getElementById("file-btn").onclick = () => fileInput.click();
  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      currentFileDraft = ev.target.result;
      previewImg.src = currentFileDraft;
      previewCont.style.display = "block"; // Show preview, don't send yet
    };
    reader.readAsDataURL(file);
    fileInput.value = ""; 
  };
  document.getElementById("remove-file-draft").onclick = () => {
    currentFileDraft = null;
    previewCont.style.display = "none";
  };

  // Sending
  document.getElementById("chat-send").onclick = handleSend;
  document.getElementById("chat-input").onkeydown = (e) => { if(e.key === "Enter") handleSend(); };

  // Onboarding
  document.getElementById("chat-submit-info").onclick = async () => {
    const f = document.getElementById("chat-fname");
    const e = document.getElementById("chat-email");
    if(!f.value.trim()){ document.getElementById("error-fname").style.display='block'; return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.value)){ document.getElementById("error-email").style.display='block'; return; }
    
    const sId = "sess_" + Date.now();
    try {
      const res = await fetch(`${BASE_URL}/app/chat/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shop, fname: f.value, email: e.value, sessionId: sId })
      });
      if (res.ok) {
        localStorage.setItem("chat_session", sId);
        localStorage.setItem("chat_user_email", e.value);
        document.getElementById("chat-onboarding-step").style.display = 'none';
        document.getElementById("chat-chat-step").style.display = 'flex';
        loadMessages();
      }
    } catch (err) {}
  };

  // Emoji
  const picker = document.getElementById("emoji-picker");
  ["ðŸ˜Š","ðŸ‘‹","ðŸ™Œ","ðŸ”¥","âœ…","ðŸ¤”","ðŸ’¡","ðŸš€","â¤ï¸","âœ¨"].forEach(em => {
    const s = document.createElement("span");
    s.innerText = em;
    s.style.cssText = "cursor:pointer; font-size: 20px; padding: 5px; text-align:center;";
    s.onclick = () => { document.getElementById("chat-input").value += em; picker.classList.add("hidden-picker"); };
    picker.appendChild(s);
  });
  document.getElementById("emoji-btn").onclick = () => picker.classList.toggle("hidden-picker");

  if(localStorage.getItem("chat_session")) {
    document.getElementById("chat-onboarding-step").style.display = 'none';
    document.getElementById("chat-chat-step").style.display = 'flex';
    loadMessages();
    setInterval(loadMessages, 3000);
  }
})();
</script>

{% schema %}
{
  "name": "Talksy Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}