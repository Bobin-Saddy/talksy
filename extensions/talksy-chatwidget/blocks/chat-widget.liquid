{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: #ffffff; color: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  
  <div id="chat-header">
    <div class="header-content">
      <div id="header-avatar-container" class="avatar-stack">
        <div class="avatar-status"></div>
        <img id="main-support-avatar" src="https://ui-avatars.com/api/?name=S" alt="Support">
      </div>
      <div class="header-text" style="position: relative;">
        <div style="display:flex; flex-direction:column; gap: 2px;">
          <span id="header-title-text" class="header-title">Live Support</span>
          <span id="header-subtitle-text" class="header-subtitle"><span class="pulse"></span> </span>
        </div>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="widget-main-container" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
    
    <div id="tab-home" class="tab-content">
      <div class="home-hero" id="home-hero-bg"> 
        <h1 id="welcome-h1">Hi there ðŸ‘‹</h1>
        <p id="welcome-p">We are here to help you! Ask us anything.</p>
      </div>
      
      <div class="home-scroll-area" id="home-scroll-area-bg">
        <div class="home-card" id="start-chat-trigger">
          <div class="card-text">
            <strong id="card-msg-text">Send us a message</strong>
            <span id="card-reply-time">Typically replies in 5 minutes</span>
          </div>
          <div class="card-arrow" id="card-arrow-bg">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </div>
        </div>

        <div class="promo-section">
          <h3 id="onboarding-title-text" >Start a conversation</h3>
          <p id="onboarding-subtitle-text" >Please provide your details to begin.</p>
        </div>
      </div>
    </div>

    <div id="tab-chat" class="tab-content" style="display:none;">
      
      <div id="chat-onboarding-step" class="step-container">
        <div class="registration-form">
          <h3 id="onboarding-form-title" style="text-align: center !important;">Identify Yourself</h3>
          <p id="onboarding-form-subtitle" style="text-align: center !important;">How should we address you?</p>
          <div class="input-group">
            <input id="chat-fname" type="text" placeholder="First Name" autocomplete="off" />
            <input id="chat-lname" type="text" placeholder="Last Name" autocomplete="off" />
            <input id="chat-email" type="email" placeholder="Email Address" autocomplete="off" />
            <button id="chat-submit-info">Start Chatting</button>
          </div>
        </div>
      </div>

      <div id="chat-chat-step" class="step-container" style="display:none;">
        <div id="chat-messages"></div>
        
        <div id="image-preview-container" style="display:none;">
          <div id="image-preview-wrapper">
            <img id="image-preview" src="" alt="Preview" />
            <button id="remove-image-btn">Ã—</button>
          </div>
          <button id="send-image-btn">Upload and Send</button>
        </div>

        <div id="chat-footer">
          <div class="input-wrapper">
            <button id="emoji-btn" class="tool-btn">ðŸ˜Š</button>
            <button id="file-btn" class="tool-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>
            <input id="chat-file-input" type="file" style="display:none;" accept="image/*" />
            <input id="chat-input" placeholder="Compose message..." autocomplete="off" />
            <button id="chat-send">
               <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
          </div>
          <div id="emoji-picker" class="hidden-picker"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Messages</span>
    </div>
  </div>
</div>

<style>
:root { 
  --chat-primary: {{ primary_color }}; 
  --chat-bg: #ffffff;
  --chat-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif, Euclid Circular ;
  --chat-font-size: 15px;
}

#chat-widget * { box-sizing: border-box; font-family: var(--chat-font) !important; margin: 0;  }

#chat-launcher { 
  position: fixed; bottom: 25px; right: 25px; width: 62px; height: 62px; border-radius: 50%; 
  display: flex; align-items: center; justify-content: center; cursor: pointer; 
  z-index: 999999; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.3s;
}
#chat-launcher:hover { transform: scale(1.08); }

#chat-widget { 
  position: fixed; bottom: 100px; right: 25px; width: 380px; height: 620px; 
  max-height: calc(100vh - 130px); background: var(--chat-bg); border-radius: 24px; 
  display: flex; flex-direction: column; overflow: hidden; 
  box-shadow: 0 15px 50px rgba(0,0,0,0.15); z-index: 999998; 
  transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); 
}
.chat-hidden { opacity: 0; transform: translateY(30px) scale(0.9); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

/* HEADER */
#chat-header { padding: 22px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.header-content { display: flex; align-items: center; gap: 12px; }
.avatar-stack { position: relative; width: 44px; height: 44px; }
.avatar-stack img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; }
.avatar-status { position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; background: #22c55e; border: 2px solid #fff; border-radius: 50%; }
.header-title { display: block; font-weight: 700; font-size: 18px; }
.header-subtitle { font-size: 13px; opacity: 0.8; display: flex; align-items: center; gap: 5px; }
.pulse { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse-anim 2s infinite; position: absolute; right: -13px; top: 15px ; }
@keyframes pulse-anim { 0%, 100% { transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
#chat-close { background: none; border: none; cursor: pointer; opacity: 0.5; transition: 0.2s; }

/* HOME TAB */
.tab-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; position: relative; }
.home-hero { padding: 35px 25px !important; text-align: center; flex-shrink: 0; }
.home-hero h1 { font-size: 28px; margin-bottom: 8px; font-weight: 800; }
.home-hero p { font-size: 15px; opacity: 0.9; line-height: 1.5; }

.home-scroll-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
.home-card { 
  background: white; padding: 24px !important; border-radius: 18px; margin: 0 20px !important;
  display: flex; align-items: center; justify-content: space-between; 
  box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s;
}
.home-card:hover { transform: translateY(-3px); }
.card-text strong { display: block; font-size: 17px; margin-bottom: 4px; color: #1e293b; }
.card-text span { font-size: 13px; color: #64748b; }
.card-arrow { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; }

.promo-section { text-align: center; padding: 20px 0; }
.promo-section h3 { font-size: 19px; color: #1e293b; margin-bottom: 6px; }
.promo-section p { font-size: 14px; color: #64748b; }

/* CHAT MESSAGES */
.step-container { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
#chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
.msg { max-width: 82%; display: flex; flex-direction: column; }
.msg.user { align-self: flex-end; }
.msg.bot { align-self: flex-start; }
.msg-content { padding: 12px 16px; border-radius: 18px; font-size: var(--chat-font-size); line-height: 1.5; word-wrap: break-word; }

/* FORM & FOOTER */
.registration-form { padding: 30px !important; }
.input-group { display: flex; flex-direction: column; gap: 12px; }
.input-group input { padding: 14px !important; border: 1px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 15px; width: 100%; }
.input-group button { padding: 15px !important; border: none; border-radius: 12px; color: white; font-weight: 700; cursor: pointer; margin-top: 10px; }

#chat-footer { padding: 15px; background: #fff; border-top: 1px solid #f1f5f9; flex-shrink: 0; position: relative; }
.input-wrapper { display: flex; align-items: center; background: #f3f4f6; border-radius: 14px; padding: 6px 12px; gap: 8px; }
#chat-input { flex: 1; border: none; background: transparent; outline: none; padding: 10px 5px; font-size: 15px; }
.tool-btn { background: none; border: none; cursor: pointer; font-size: 1.3em; color: #94a3b8; }
#chat-send { color: #fff; border: none; border-radius: 10px; padding: 9px; cursor: pointer; display: flex; align-items: center; background: var(--chat-primary); }

/* NAV */
#chat-nav { display: flex; border-top: 1px solid #f1f5f9; background: #fff; padding: 10px 0; flex-shrink: 0; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; font-size: 11px; color: #94a3b8; gap: 4px; }
.nav-item.active { color: var(--chat-primary); font-weight: 700; }

/* EMOJI */
.hidden-picker { display: none !important; }
#emoji-picker { position: absolute; bottom: 85px; left: 15px; right: 15px; background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 12px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://talksy-production-322d.up.railway.app"; 
  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const chatInput = document.getElementById("chat-input");
  const msgBox = document.getElementById("chat-messages");
  
  let selectedImg = null;
  let pollInterval = null; 
  let currentConfig = {};
  let seenMsgs = new Set();

  const ICON_SVGS = {
    bubble: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',
    send: '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',
    defaultCustom: '<img src="https://alert-lime-e4qtqvlkob.edgeone.app/icon-frame.png" style="width:30px;height:30px;object-fit:contain;"/>'
  };

  async function loadSettings() {
    try {
      const r = await fetch(`${BASE_URL}/api/chat-settings?shop=${shop}`);
      const s = await r.json();
      currentConfig = s;
      
      // 1. COLORS, FONTS & BORDERS
      document.documentElement.style.setProperty('--chat-primary', s.primaryColor);
      document.documentElement.style.setProperty('--chat-font', s.fontFamily);
      document.documentElement.style.setProperty('--chat-font-size', s.baseFontSize);

      widget.style.border = `1px solid ${s.widgetBorderColor}`;
      widget.style.background = s.chatBoxBgColor;
      launcher.style.color = s.primaryColor;

      // Header Sync
      const header = document.getElementById("chat-header");
      header.style.background = s.headerBgColor;
      header.style.color = s.headerTextColor;
      header.style.borderBottom = `1px solid ${s.widgetBorderColor}`;
      document.getElementById("header-title-text").innerText = s.headerTitle;

      // Hero Sync
      const hero = document.getElementById("home-hero-bg");
      hero.style.background = s.heroBgColor;
      hero.style.color = s.heroTextColor;
      document.getElementById("welcome-h1").innerText = s.welcomeText;
      document.getElementById("welcome-p").innerText = s.welcomeSubtext;

      // Body BG Sync
      document.getElementById("home-scroll-area-bg").style.background = s.chatBoxBgColor;

      // Card Sync
      const card = document.getElementById("start-chat-trigger");
      card.style.background = s.messageBgColor;
      card.style.border = `1px solid ${s.widgetBorderColor}`;
      document.getElementById("card-msg-text").innerText = s.startConversationText;
      document.getElementById("card-msg-text").style.color = s.cardTitleColor;
      document.getElementById("card-reply-time").innerText = s.replyTimeText;
      document.getElementById("card-reply-time").style.color = s.cardSubtitleColor;
      document.getElementById("card-arrow-bg").style.background = s.primaryColor;

      // Onboarding & Promo Sync
      document.getElementById("onboarding-title-text").innerText = s.onboardingTitle;
      document.getElementById("onboarding-subtitle-text").innerText = s.onboardingSubtitle;
      document.getElementById("onboarding-title-text").style.color = s.onboardingTextColor;
      document.getElementById("onboarding-subtitle-text").style.color = s.onboardingTextColor;

      // Support Avatar Sync
      document.getElementById("main-support-avatar").src = s.welcomeImg;

      // Form Text Sync
      document.getElementById("onboarding-form-title").innerText = s.onboardingTitle;
      document.getElementById("onboarding-form-subtitle").innerText = s.onboardingSubtitle;
      document.getElementById("chat-submit-info").style.background = s.primaryColor;

      // 2. ICON LOGIC
      if (s.launcherIcon === 'custom' && s.customLauncherImg) {
        document.getElementById("launcher-icon").innerHTML = `<img src="${s.customLauncherImg}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;"/>`;
      } else {
        document.getElementById("launcher-icon").innerHTML = ICON_SVGS[s.launcherIcon] || ICON_SVGS.bubble;
      }

      if(localStorage.getItem("chat_session")) {
        document.getElementById("chat-onboarding-step").style.display = "none";
        document.getElementById("chat-chat-step").style.display = "flex";
        startPolling();
      }
    } catch (e) { console.error("Setup Error", e); }
  }

  async function fetchMessages() {
    const sId = localStorage.getItem("chat_session");
    if (!sId) return;
    try {
      const res = await fetch(`${BASE_URL}/app/chat/messages?shop=${shop}&sessionId=${sId}`);
      const data = await res.json();
      data.sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt)).forEach(renderMsg);
    } catch (e) {}
  }

  function renderMsg(m) {
    if (seenMsgs.has(m.id)) return;
    seenMsgs.add(m.id);
    const div = document.createElement("div");
    const isBot = (m.sender === 'admin' || m.sender === 'bot');
    div.className = `msg ${isBot ? 'bot' : 'user'}`;
    const bg = isBot ? (currentConfig.messageBgColor || "#fff") : "var(--chat-primary)";
    const color = isBot ? "#1e293b" : "#fff";
    const border = isBot ? `1px solid ${currentConfig.widgetBorderColor}` : 'none';
    div.innerHTML = `<div class="msg-content" style="background:${bg}; color:${color}; border:${border}">${m.message ? `<div>${m.message}</div>` : ''}${m.fileUrl ? `<img src="${m.fileUrl}" style="max-width:100%; border-radius:10px; margin-top:8px; display:block;" />` : ''}</div>`;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  }

  async function postMessage(txt = "", file = null) {
    const sId = localStorage.getItem("chat_session");
    const message = txt || chatInput.value.trim();
    if ((!message && !file) || !sId) return;
    chatInput.value = "";
    try {
      await fetch(`${BASE_URL}/app/chat/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId: sId, shop, message, fileUrl: file, email: localStorage.getItem("chat_user_email"), fname: localStorage.getItem("chat_user_fname") })
      });
      fetchMessages();
    } catch (e) {}
  }

  launcher.onclick = () => {
    const open = widget.classList.toggle("chat-visible");
    widget.classList.toggle("chat-hidden", !open);
    document.getElementById("launcher-icon").style.display = open ? "none" : "block";
    document.getElementById("close-launcher-icon").style.display = open ? "flex" : "none";
  };

  document.querySelectorAll('.nav-item').forEach(nav => {
    nav.onclick = () => {
      const tab = nav.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      document.getElementById(`tab-${tab}`).style.display = 'flex';
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      nav.classList.add('active');
      if(tab === 'chat') { fetchMessages(); setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 100); }
    };
  });

  document.getElementById("chat-submit-info").onclick = async () => {
    const f = document.getElementById("chat-fname").value;
    const e = document.getElementById("chat-email").value;
    if(!f || !e) return alert("Required fields missing");
    const sId = "s_" + Date.now();
    const res = await fetch(`${BASE_URL}/app/chat/register`, {
      method: "POST", headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ shop, fname: f, email: e, sessionId: sId })
    });
    if(res.ok) {
      localStorage.setItem("chat_session", sId);
      localStorage.setItem("chat_user_fname", f);
      localStorage.setItem("chat_user_email", e);
      document.getElementById("chat-onboarding-step").style.display = "none";
      document.getElementById("chat-chat-step").style.display = "flex";
      startPolling();
    }
  };

  const fInput = document.getElementById("chat-file-input");
  document.getElementById("file-btn").onclick = () => fInput.click();
  fInput.onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      selectedImg = ev.target.result;
      document.getElementById("image-preview").src = selectedImg;
      document.getElementById("image-preview-container").style.display = "block";
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  document.getElementById("send-image-btn").onclick = () => {
    postMessage("", selectedImg);
    selectedImg = null;
    document.getElementById("image-preview-container").style.display = "none";
  };

  document.getElementById("remove-image-btn").onclick = () => {
    selectedImg = null;
    document.getElementById("image-preview-container").style.display = "none";
  };

  const picker = document.getElementById("emoji-picker");
  const ems = ["ðŸ˜Š","ðŸ‘‹","ðŸ™Œ","ðŸ”¥","âœ…","ðŸ¤”","ðŸ’¡","ðŸš€","â¤ï¸","âœ¨","ðŸ‘","ðŸ™"];
  picker.innerHTML = ems.map(em => `<span class="e-item" style="cursor:pointer; font-size:22px;">${em}</span>`).join("");
  document.getElementById("emoji-btn").onclick = (e) => { e.stopPropagation(); picker.classList.toggle("hidden-picker"); };
  picker.onclick = (e) => {
    if(e.target.classList.contains('e-item')) {
      chatInput.value += e.target.innerText;
      picker.classList.add("hidden-picker");
      chatInput.focus();
    }
  };

  function startPolling() {
    fetchMessages();
    if(pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(fetchMessages, 3500);
  }

  chatInput.onkeydown = (e) => { if(e.key === 'Enter') postMessage(); };
  document.getElementById("chat-send").onclick = () => postMessage();
  document.getElementById("chat-close").onclick = () => launcher.click();
  document.getElementById("start-chat-trigger").onclick = () => document.querySelector('[data-tab="chat"]').click();

  loadSettings();
})();
</script>

{% schema %}
{
  "name": "Talksy Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}